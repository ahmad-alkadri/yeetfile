services:
    api:
        build:
            context: .
            network: host
        container_name: yeetfile
        restart: unless-stopped
        ports:
            - 8090:${YEETFILE_PORT:-8090}
        expose:
            - 8090
        depends_on:
            db:
                condition: service_healthy
            minio:
                condition: service_started
            createbuckets:
                condition: service_completed_successfully
        volumes:
            - yeetfile_uploads:/app/uploads
        environment:
            - YEETFILE_DEBUG=${YEETFILE_DEBUG:-0}
            - YEETFILE_STORAGE=${YEETFILE_STORAGE:-s3}
            - YEETFILE_DEFAULT_USER_STORAGE=${YEETFILE_DEFAULT_USER_STORAGE:-2000000000}
            - YEETFILE_DEFAULT_USER_SEND=${YEETFILE_DEFAULT_USER_SEND:-250000000}
            - YEETFILE_SERVER_SECRET=${YEETFILE_SERVER_SECRET}
            - YEETFILE_SESSION_AUTH_KEY=${YEETFILE_SESSION_AUTH_KEY}
            - YEETFILE_SESSION_ENC_KEY=${YEETFILE_SESSION_ENC_KEY}
            - YEETFILE_HOST=${YEETFILE_HOST:-0.0.0.0}
            - YEETFILE_PORT=${YEETFILE_PORT:-8090}
            - YEETFILE_DB_USER=${YEETFILE_DB_USER:-yeetfile_user}
            - YEETFILE_DB_PASS=${YEETFILE_DB_PASS:-${YEETFILE_DB_PASSWORD}}
            - YEETFILE_DB_NAME=${YEETFILE_DB_NAME:-yeetfile}
            - YEETFILE_DB_HOST=db
            - YEETFILE_S3_ENDPOINT=${YEETFILE_S3_ENDPOINT:-http://minio:9000}
            - YEETFILE_S3_BUCKET_NAME=${YEETFILE_S3_BUCKET_NAME:-yeetfile}
            - YEETFILE_S3_REGION_NAME=${YEETFILE_S3_REGION_NAME:-us-east-1}
            - YEETFILE_S3_ACCESS_KEY_ID=${YEETFILE_S3_ACCESS_KEY_ID:-${MINIO_ROOT_USER:-yeetfile_s3_user}}
            - YEETFILE_S3_SECRET_KEY=${YEETFILE_S3_SECRET_KEY:-${MINIO_ROOT_PASSWORD}}
            - YEETFILE_INSTANCE_ADMIN=${YEETFILE_INSTANCE_ADMIN:-4418110129398725}

    minio:
        image: minio/minio
        container_name: yeetfile-minio
        restart: unless-stopped
        ports:
            - 9010:9000
            - 9011:9001
        environment:
            - MINIO_ROOT_USER=${YEETFILE_S3_ACCESS_KEY_ID:-${MINIO_ROOT_USER:-yeetfile_s3_user}}
            - MINIO_ROOT_PASSWORD=${YEETFILE_S3_SECRET_KEY:-${MINIO_ROOT_PASSWORD}}
        volumes:
            - yeetfile_minio:/data
        command: server /data --console-address ":9001"
        healthcheck:
            test:
                ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
            interval: 3s
            timeout: 3s
            retries: 5

    createbuckets:
        image: minio/mc
        container_name: yeetfile-mc
        depends_on:
            minio:
                condition: service_healthy
        entrypoint: >
            /bin/sh -c "
            /usr/bin/mc alias set myminio http://minio:9000 ${YEETFILE_S3_ACCESS_KEY_ID:-${MINIO_ROOT_USER:-yeetfile_s3_user}} ${YEETFILE_S3_SECRET_KEY:-${MINIO_ROOT_PASSWORD}};
            /usr/bin/mc mb myminio/yeetfile;
            exit 0;
            "

    db:
        image: postgres:16-alpine
        container_name: yeetfile-db
        restart: unless-stopped
        volumes:
            - yeetfile_db:/var/lib/postgresql/data
        environment:
            - POSTGRES_HOST_AUTH_METHOD=${POSTGRES_HOST_AUTH_METHOD:-md5}
            - POSTGRES_USER=${YEETFILE_DB_USER:-yeetfile_user}
            - POSTGRES_PASSWORD=${YEETFILE_DB_PASS:-${YEETFILE_DB_PASSWORD}}
            - POSTGRES_DB=${YEETFILE_DB_NAME:-yeetfile}
        expose:
            - 5432
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 3s

volumes:
    yeetfile_uploads:
    yeetfile_minio:
    yeetfile_db:
